<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Gêmeo Digital Municipal — Demo (Hipotético)</title>

  <!-- Leaflet core -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

  <!-- Leaflet Draw for measure/draw tools -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.css" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.js"></script>

  <!-- Geocoder (Nominatim) -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css" />
  <script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>

  <!-- EasyPrint (export PNG) -->
  <script src="https://unpkg.com/leaflet-easyprint@2.1.9/dist/bundle.js"></script>

  <style>
    html, body, #map { height: 100%; margin: 0; }
    .sidebar {
      position: absolute; top: 10px; left: 10px; z-index: 1000;
      background: rgba(255,255,255,0.95); border-radius: 12px; padding: 12px;
      max-width: 320px; box-shadow: 0 10px 25px rgba(0,0,0,0.15);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, 'Helvetica Neue', Arial, 'Noto Sans', 'Apple Color Emoji', 'Segoe UI Emoji';
    }
    .sidebar h1 { font-size: 16px; margin: 0 0 8px; }
    .layer-item { display: flex; align-items: center; gap: 8px; margin: 6px 0; }
    .opacity { width: 80px; }
    .legend {
      position: absolute; bottom: 20px; left: 10px; z-index: 1000;
      background: rgba(255,255,255,0.95); border-radius: 12px; padding: 10px; min-width: 160px;
      box-shadow: 0 10px 25px rgba(0,0,0,0.15);
    }
    .legend h3 { font-size: 13px; margin: 0 0 6px; }
    .legend .item { display: flex; align-items: center; gap: 8px; margin: 4px 0; font-size: 12px;}
    .color-box { width: 14px; height: 14px; border-radius: 3px; border: 1px solid #888; }
    .north-arrow {
      position: absolute; right: 20px; top: 20px; z-index: 1000;
      background: rgba(255,255,255,0.9); border-radius: 12px; padding: 8px;
      box-shadow: 0 10px 25px rgba(0,0,0,0.15);
    }
    .info-panel {
      position: absolute; right: 20px; bottom: 20px; z-index: 1000;
      background: rgba(255,255,255,0.98); border-radius: 12px; padding: 12px; width: 320px; max-height: 40%;
      overflow: auto; box-shadow: 0 10px 25px rgba(0,0,0,0.15); font-size: 13px;
    }
    .toolbar { display: flex; gap: 8px; margin-top: 8px; flex-wrap: wrap; }
    .btn {
      background: #111; color: #fff; border: none; padding: 8px 10px; border-radius: 8px; cursor: pointer; font-size: 12px;
    }
    .btn.light { background: #f0f0f0; color:#111; border:1px solid #ddd; }
    .small { font-size: 11px; color: #666; }
    .divider { height: 1px; background: #eee; margin: 8px 0; }
    .badge { font-size: 10px; background:#eef; color:#224; padding:2px 6px; border-radius: 6px; border:1px solid #ccd; }
    .range-row{display:flex; align-items:center; gap:6px;}
    .range-row label{width: 120px; font-size:12px;}
    .range-row input[type="range"]{flex:1;}
  </style>
</head>
<body>
  <div id="map"></div>

  <!-- Sidebar controls -->
  <div class="sidebar">
    <h1>Gêmeo Digital — Demo</h1>
    <div class="small">Cidade hipotética • Norte, escala, medir, busca, impressão</div>
    <div class="divider"></div>

    <div class="toolbar">
      <button id="btnBaseStreets" class="btn light">Mapa de Ruas</button>
      <button id="btnBaseSat" class="btn light">Satélite</button>
      <button id="btnReset" class="btn light">Reset View</button>
      <button id="btnPrint" class="btn">Exportar PNG</button>
    </div>

    <div class="divider"></div>
    <div class="badge">Camadas</div>

    <div id="layers"></div>

    <div class="divider"></div>
    <div class="badge">Opacidade</div>
    <div id="opacityControls"></div>

    <div class="divider"></div>
    <div class="badge">Busca</div>
    <div class="small">Use o ícone de lupa no mapa (geocodificação global) ou clique em objetos para detalhes.</div>
  </div>

  <!-- Legend -->
  <div class="legend" id="legend">
    <h3>Legenda</h3>
    <div class="item"><span class="color-box" style="background:#f3c; border-color:#a06;"></span> Plano Diretor — Zona Central</div>
    <div class="item"><span class="color-box" style="background:#39c; border-color:#168;"></span> Plano Diretor — Zona Residencial</div>
    <div class="item"><span class="color-box" style="background:#3c9; border-color:#186;"></span> Meio Ambiente — APP</div>
    <div class="item"><span class="color-box" style="background:#f66; border-color:#c33;"></span> Áreas de Risco/Inundação</div>
    <div class="item"><span class="color-box" style="background:#ff0; border-color:#cc0;"></span> Distrito Industrial</div>
    <div class="item"><span class="color-box" style="background:#333; border-color:#111;"></span> Vias Principais</div>
    <div class="item"><span class="color-box" style="background:#00bcd4; border-color:#008b9d;"></span> Hidrografia</div>
    <div class="item"><span class="color-box" style="background:#8bc34a; border-color:#5a8a2e;"></span> Pontos Turísticos</div>
  </div>

  <!-- North arrow -->
  <div class="north-arrow" title="Norte geográfico">
    <svg width="40" height="40" viewBox="0 0 100 100" aria-hidden="true">
      <defs>
        <linearGradient id="g" x1="0" x2="0" y1="0" y2="1">
          <stop offset="0" stop-color="#000"/>
          <stop offset="1" stop-color="#666"/>
        </linearGradient>
      </defs>
      <circle cx="50" cy="50" r="45" fill="white" stroke="#333" stroke-width="4"/>
      <polygon points="50,10 62,50 50,44 38,50" fill="url(#g)" stroke="#111" stroke-width="2"/>
      <text x="50" y="88" text-anchor="middle" font-family="Arial" font-size="18" fill="#111">N</text>
    </svg>
  </div>

  <!-- Info panel -->
  <div class="info-panel" id="info">
    <strong>Informações</strong>
    <div id="infoContent" class="small">Clique em um objeto do mapa para ver detalhes (zoneamento, lote do distrito, risco, atrativos).</div>
  </div>

  <script>
    // ---------- BASE MAPS ----------
    const baseStreets = L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19,
      attribution: '&copy; OpenStreetMap'
    });
    const baseSat = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
      maxZoom: 19,
      attribution: 'Esri World Imagery'
    });

    // ---------- MAP ----------
    const map = L.map('map', {
      center: [-27.60, -48.50], // sul do Brasil (hipotético)
      zoom: 13,
      layers: [baseStreets]
    });

    // Scale
    L.control.scale({imperial:false}).addTo(map);

    // Geocoder
    const geocoder = L.Control.geocoder({
      defaultMarkGeocode: true
    }).addTo(map);

    // Print (PNG)
    const printer = L.easyPrint({
      tileLayer: baseStreets,
      sizeModes: ['Current', 'A4Landscape', 'A4Portrait'],
      filename: 'gemeo_digital_mapa',
      exportOnly: true,
      hideControlContainer: true
    }).addTo(map);

    document.getElementById('btnPrint').addEventListener('click', () => {
      printer.printMap('CurrentSize', 'gemeo_digital_mapa');
    });

    // Reset view
    const defaultView = {center: [-27.60, -48.50], zoom:13};
    document.getElementById('btnReset').addEventListener('click', () => {
      map.setView(defaultView.center, defaultView.zoom);
    });

    // Switch base
    document.getElementById('btnBaseStreets').addEventListener('click', () => {
      map.removeLayer(baseSat); if(!map.hasLayer(baseStreets)) baseStreets.addTo(map);
    });
    document.getElementById('btnBaseSat').addEventListener('click', () => {
      map.removeLayer(baseStreets); if(!map.hasLayer(baseSat)) baseSat.addTo(map);
    });

    // ---------- HYPOTHETICAL DATA (GEOJSON) ----------
    // Simple helper colors
    const colors = {
      zonaCentral: '#f3c',
      zonaResid: '#39c',
      app: '#3c9',
      risco: '#f66',
      di: '#ff0',
      vias: '#333',
      agua: '#00bcd4',
      turismo: '#8bc34a'
    };

    // Plano Diretor — duas zonas poligonais
    const planoDiretor = {
      "type":"FeatureCollection",
      "features":[
        {"type":"Feature","properties":{"zona":"ZC - Zona Central","uso_principal":"misto","gabarito":"6 pav.","coef_aprov":3.0,"tx_ocup":0.7},
         "geometry":{"type":"Polygon","coordinates":[[
           [-48.515, -27.595],[-48.505, -27.595],[-48.505, -27.605],[-48.515,-27.605],[-48.515,-27.595]
         ]]} },
        {"type":"Feature","properties":{"zona":"ZR - Zona Residencial","uso_principal":"residencial","gabarito":"3 pav.","coef_aprov":1.5,"tx_ocup":0.5},
         "geometry":{"type":"Polygon","coordinates":[[
           [-48.505, -27.595],[-48.495, -27.595],[-48.495, -27.605],[-48.505,-27.605],[-48.505,-27.595]
         ]]} }
      ]
    };

    // Bairros (polígonos mais amplos)
    const bairros = {
      "type":"FeatureCollection",
      "features":[
        {"type":"Feature","properties":{"nome":"Centro","populacao":8200,"densidade_hab_km2":4500,"renda_media":3200},
         "geometry":{"type":"Polygon","coordinates":[[
           [-48.520,-27.590],[-48.495,-27.590],[-48.495,-27.610],[-48.520,-27.610],[-48.520,-27.590]
         ]]} },
        {"type":"Feature","properties":{"nome":"Bairro Verde","populacao":5400,"densidade_hab_km2":1800,"renda_media":2500},
         "geometry":{"type":"Polygon","coordinates":[[
           [-48.500,-27.600],[-48.485,-27.600],[-48.485,-27.615],[-48.500,-27.615],[-48.500,-27.600]
         ]]} }
      ]
    };

    // Meio Ambiente — APP (faixas alongando rio)
    const appAreas = {
      "type":"FeatureCollection",
      "features":[
        {"type":"Feature","properties":{"tipo":"APP Rio Principal"},
         "geometry":{"type":"Polygon","coordinates":[[
            [-48.510,-27.600],[-48.508,-27.600],[-48.506,-27.610],[-48.508,-27.612],[-48.510,-27.602],[-48.512,-27.602],[-48.510,-27.600]
         ]]} }
      ]
    };

    // Risco/Inundação — manchas
    const risco = {
      "type":"FeatureCollection",
      "features":[
        {"type":"Feature","properties":{"classe_risco":"Alta","periodo_retorno":"10 anos"},
         "geometry":{"type":"Polygon","coordinates":[[
           [-48.507,-27.603],[-48.503,-27.603],[-48.503,-27.607],[-48.507,-27.607],[-48.507,-27.603]
         ]]} }
      ]
    };

    // Distrito Industrial — lotes
    const distritoInd = {
      "type":"FeatureCollection",
      "features":[
        {"type":"Feature","properties":{"lote":"Lote 01","area_m2":2500,"status":"disponível","infra":"energia, água, fibra"},
         "geometry":{"type":"Polygon","coordinates":[[
           [-48.520,-27.605],[-48.517,-27.605],[-48.517,-27.610],[-48.520,-27.610],[-48.520,-27.605]
         ]]} },
        {"type":"Feature","properties":{"lote":"Lote 02","area_m2":2600,"status":"ocupado","infra":"energia, água, fibra"},
         "geometry":{"type":"Polygon","coordinates":[[
           [-48.517,-27.605],[-48.514,-27.605],[-48.514,-27.610],[-48.517,-27.610],[-48.517,-27.605]
         ]]} }
      ]
    };

    // Vias principais — linhas
    const vias = {
      "type":"FeatureCollection",
      "features":[
        {"type":"Feature","properties":{"nome":"Av. Central","class":"arterial"},
         "geometry":{"type":"LineString","coordinates":[[-48.520,-27.597],[-48.495,-27.603]]}},
        {"type":"Feature","properties":{"nome":"Av. Parque","class":"coletora"},
         "geometry":{"type":"LineString","coordinates":[[-48.514,-27.610],[-48.498,-27.595]]}}
      ]
    };

    // Hidrografia — linhas/pontos
    const rios = {
      "type":"FeatureCollection",
      "features":[
        {"type":"Feature","properties":{"nome":"Rio Azul"},
         "geometry":{"type":"LineString","coordinates":[[-48.515,-27.598],[-48.505,-27.602],[-48.495,-27.607]]}}
      ]
    };

    // Pontos turísticos — pontos
    const turismo = {
      "type":"FeatureCollection",
      "features":[
        {"type":"Feature","properties":{"nome":"Mirante do Sol","tipo":"mirante","avaliacao_media":4.6},
         "geometry":{"type":"Point","coordinates":[-48.500,-27.605]}},
        {"type":"Feature","properties":{"nome":"Museu Municipal","tipo":"museu","avaliacao_media":4.4},
         "geometry":{"type":"Point","coordinates":[-48.508,-27.600]}}
      ]
    };

    // ---------- LAYER BUILDERS ----------
    function stylePlano(feature){
      const z = feature.properties.zona || '';
      const color = z.includes('Central') ? colors.zonaCentral : colors.zonaResid;
      return { color: color, weight: 1.5, fillColor: color, fillOpacity: 0.35 };
    }
    function styleAPP(){ return { color: colors.app, weight: 1, dashArray:'4 3', fillColor: colors.app, fillOpacity: 0.25 }; }
    function styleRisco(){ return { color: colors.risco, weight: 1, fillColor: colors.risco, fillOpacity: 0.35 }; }
    function styleDI(){ return { color: '#cc0', weight: 1, fillColor: colors.di, fillOpacity: 0.35 }; }
    function styleVias(feature){
      const w = feature.properties.class === 'arterial' ? 5 : 3;
      return { color: colors.vias, weight: w, opacity: 0.85 };
    }
    function styleRios(){ return { color: colors.agua, weight: 3, opacity: 0.8 }; }
    function styleTurismo(){ return {}; }

    const planLayer = L.geoJSON(planoDiretor, {
      style: stylePlano,
      onEachFeature: (f, layer) => {
        layer.on('click', () => showInfo('Plano Diretor', f.properties));
      }
    });

    const bairrosLayer = L.geoJSON(bairros, {
      style: {color:'#777', weight:1.2, fillColor:'#aaa', fillOpacity:0.15},
      onEachFeature: (f, layer) => {
        layer.on('click', () => showInfo('Bairro', f.properties));
      }
    });

    const appLayer = L.geoJSON(appAreas, {
      style: styleAPP,
      onEachFeature: (f, layer) => layer.on('click', () => showInfo('APP', f.properties))
    });

    const riscoLayer = L.geoJSON(risco, {
      style: styleRisco,
      onEachFeature: (f, layer) => layer.on('click', () => showInfo('Risco/Inundação', f.properties))
    });

    const diLayer = L.geoJSON(distritoInd, {
      style: styleDI,
      onEachFeature: (f, layer) => layer.on('click', () => showInfo('Distrito Industrial', f.properties))
    });

    const viasLayer = L.geoJSON(vias, {
      style: styleVias,
      onEachFeature: (f, layer) => layer.on('click', () => showInfo('Via Principal', f.properties))
    });

    const riosLayer = L.geoJSON(rios, {
      style: styleRios,
      onEachFeature: (f, layer) => layer.on('click', () => showInfo('Hidrografia', f.properties))
    });

    const turismoLayer = L.geoJSON(turismo, {
      pointToLayer: (f, latlng) => L.circleMarker(latlng, {
        radius: 7, weight:1.5, color:'#4a7', fillColor: colors.turismo, fillOpacity:0.9
      }),
      onEachFeature: (f, layer) => layer.on('click', () => showInfo('Ponto Turístico', f.properties))
    });

    // Add default layers
    planLayer.addTo(map);
    bairrosLayer.addTo(map);
    viasLayer.addTo(map);
    riosLayer.addTo(map);
    appLayer.addTo(map);
    riscoLayer.addTo(map);
    diLayer.addTo(map);
    turismoLayer.addTo(map);

    // ---------- DRAW / MEASURE ----------
    const drawnItems = new L.FeatureGroup();
    map.addLayer(drawnItems);
    const drawControl = new L.Control.Draw({
      draw: {
        polygon: { allowIntersection: false, showArea: true, metric: ['km','m'] },
        polyline: { metric: ['km','m'] },
        rectangle: true,
        circle: false,
        circlemarker: false,
        marker: true
      },
      edit: { featureGroup: drawnItems }
    });
    map.addControl(drawControl);
    map.on(L.Draw.Event.CREATED, function (e) {
      var layer = e.layer;
      drawnItems.addLayer(layer);
      // Basic measurement display
      if (e.layerType === 'polyline') {
        const len = L.GeometryUtil.length(layer.getLatLngs());
        showInfo('Medida — Linha', { 'Comprimento (m aprox)': len.toFixed(1) });
      } else if (e.layerType === 'polygon' || e.layerType === 'rectangle') {
        const area = L.GeometryUtil.geodesicArea(layer.getLatLngs()[0]);
        showInfo('Medida — Área', { 'Área (m² aprox)': area.toFixed(1) });
      } else if (e.layerType === 'marker') {
        showInfo('Marcador', { 'Coordenadas': layer.getLatLng().lat.toFixed(6)+', '+layer.getLatLng().lng.toFixed(6) });
      }
    });

    // Include GeometryUtil for measurements
    const geomScript = document.createElement('script');
    geomScript.src = 'https://unpkg.com/leaflet-geometryutil@0.10.2/src/leaflet.geometryutil.js';
    document.head.appendChild(geomScript);

    // ---------- UI helpers ----------
    function showInfo(title, obj){
      const c = document.getElementById('infoContent');
      const rows = Object.entries(obj).map(([k,v]) => `<div><strong>${k}:</strong> ${v}</div>`).join('');
      c.innerHTML = `<div style="margin-bottom:6px;"><strong>${title}</strong></div>${rows}`;
    }

    // Layers registry for opacity/UI
    const registry = [
      {name:'Plano Diretor', layer: planLayer, type:'vector'},
      {name:'Bairros', layer: bairrosLayer, type:'vector'},
      {name:'Meio Ambiente (APP)', layer: appLayer, type:'vector'},
      {name:'Risco/Inundação', layer: riscoLayer, type:'vector'},
      {name:'Distrito Industrial', layer: diLayer, type:'vector'},
      {name:'Vias Principais', layer: viasLayer, type:'vector'},
      {name:'Hidrografia', layer: riosLayer, type:'vector'},
      {name:'Pontos Turísticos', layer: turismoLayer, type:'vector'}
    ];

    const layersDiv = document.getElementById('layers');
    const opsDiv = document.getElementById('opacityControls');

    registry.forEach((it, idx) => {
      // Toggle checkbox
      const id = 'layer_' + idx;
      const row = document.createElement('div');
      row.className = 'layer-item';
      row.innerHTML = `<input type="checkbox" id="${id}" checked />
                       <label for="${id}">${it.name}</label>`;
      layersDiv.appendChild(row);
      document.getElementById(id).addEventListener('change', (ev) => {
        if(ev.target.checked){ it.layer.addTo(map); }
        else { map.removeLayer(it.layer); }
      });

      // Opacity range
      const opId = 'op_' + idx;
      const r = document.createElement('div');
      r.className = 'range-row';
      r.innerHTML = `<label for="${opId}">${it.name}</label>
                     <input type="range" id="${opId}" min="0" max="1" step="0.05" value="1" />`;
      opsDiv.appendChild(r);
      document.getElementById(opId).addEventListener('input', (ev) => {
        const v = parseFloat(ev.target.value);
        // For GeoJSON vector layers, we need to restyle
        it.layer.setStyle && it.layer.setStyle((feat) => {
          const st = it.layer.options.style ? (typeof it.layer.options.style === 'function' ? it.layer.options.style(feat) : it.layer.options.style) : {color:'#000'};
          // apply generic opacity
          return Object.assign({}, st, {
            opacity: (st.opacity!==undefined ? st.opacity : 1) * v,
            fillOpacity: (st.fillOpacity!==undefined ? st.fillOpacity : 0.35) * v
          });
        });
        // For circleMarkers in turismo
        if(it.name==='Pontos Turísticos'){
          it.layer.eachLayer(l => {
            if(l.setStyle){
              const st = Object.assign({}, l.options, {opacity: v, fillOpacity: v});
              l.setStyle(st);
            }
          });
        }
      });
    });

    // Fit bounds to all layers
    const group = L.featureGroup(registry.map(r => r.layer));
    map.fitBounds(group.getBounds().pad(0.2));

  </script>
</body>
</html>
